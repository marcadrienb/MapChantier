<!DOCTYPE html>
<html>
<head>
  <title>Carte des chantiers</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSm9kfPQqWWck-16_y5OUz1ObSyHmknWE&libraries=geometry" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
  <script>
    async function initMap() {
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAnlvX5DBICbNnV01Eutb1t0dPTJqHFvvePxgfWXEqEg7AHsMBPsiLNg4FI-aFYnChf4MJdg3IcHOb/pub?output=csv";

      try {
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error(`Erreur HTTP : ${response.status}`);
        }
        const csvData = await response.text();

        Papa.parse(csvData, {
          header: true,
          dynamicTyping: true,
          complete: function(results) {
            const data = results.data;
            console.log("Données CSV parsées :", data);

            const map = new google.maps.Map(document.getElementById("map"), {
              center: { lat: 46.5191, lng: 6.5668 },
              zoom: 8,
            });

            const couleursEntites = {
              "100 - PHIDA ETANCHEITE VD": "red",
              "200 - Autre entité": "blue",
              "300 - Entité C": "green",
            };

            // Entity markers and counts
            const entityMarkers = {};
            let mostAddressesEntity = "";
            let mostAddressesCount = 0;

            data.forEach(row => {
              if (row && !isNaN(row.Latitude) && !isNaN(row.Longitude)) {
                try {
                  const latLng = new google.maps.LatLng(row.Latitude, row.Longitude);

                  const entity = row.Entité;

                  // Create or update entity marker array
                  if (!entityMarkers[entity]) {
                    entityMarkers[entity] = [];
                  }
                  entityMarkers[entity].push(latLng);

                  // Track entity with most addresses
                  if (entityMarkers[entity].length > mostAddressesCount) {
                    mostAddressesEntity = entity;
                    mostAddressesCount = entityMarkers[entity].length;
                  }

                  const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: `N° Chantier : ${row["N° de chantier"]}`,
                    icon: {
                      path: google.maps.SymbolPath.CIRCLE,
                      scale: 10,
                      fillColor: couleursEntites[entity] || "gray",
                      fillOpacity: 1,
                      strokeWeight: 1,
                    },
                  });

                  const infoWindowContent = `
                    <div style="padding: 10px;">
                      <h3>N° Chantier : ${row["N° de chantier"]}</h3>
                      <p><b>Valeur :</b> ${row["CA+0"]}</p>
                      <p><b>Entité :</b> ${row.Entité}</p>
                      <p><b>Entretien :</b> ${row.Entretien}</p>
                    </div>
                  `;

                  const infoWindow = new google.maps.InfoWindow({
                    content: infoWindowContent,
                  });

                  marker.addListener("click", () => infoWindow.open(map, marker));
                } catch (error) {
                  console.error(`Erreur lors de la création du marqueur : ${error}, pour les coordonnées : Latitude ${row.Latitude}, Longitude ${row.Longitude}`);
                }
              }
            });

            // Center map on entity with most addresses (if any)
            if (mostAddressesEntity) {
              const entityBounds = new google.maps.LatLngBounds();
              entityMarkers[mostAddressesEntity].forEach(latLng => entityBounds.extend(latLng));
              map.fitBounds(entityBounds);
            }
