<!DOCTYPE html>
<html>
<head>
    <title>Carte des chantiers</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
    <script>
        async function initMap() {
            const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAnlvX5DBICbNnV01Eutb1t0dPTJqHFvvePxgfWXEqEg7AHsMBPsiLNg4FI-aFYnChf4MJdg3IcHOb/pub?output=csv";

            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
                }
                const csvData = await response.text();

                Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        const data = results.data;
                        console.log("Données CSV parsées :", data);

                        const map = new google.maps.Map(document.getElementById("map"), {
                            center: { lat: 46.5191, lng: 6.5668 },
                            zoom: 8,
                        });

                        const couleursEntites = {
                            "100 - PHIDA ETANCHEITE VD": "red",
                            "200 - Autre entité": "blue",
                            "300 - Entité C": "green",
                        };

                        let latLngBounds = new google.maps.LatLngBounds();

                        data.forEach(row => {
                            if (row && !isNaN(row.Latitude) && !isNaN(row.Longitude)) { // Vérification que la ligne n'est pas vide
                                try {
                                    let latLng = new google.maps.LatLng(row.Latitude, row.Longitude);
                                    latLngBounds.extend(latLng);

                                    const marker = new google.maps.Marker({
                                        position: latLng,
                                        map: map,
                                        title: `N° Chantier : ${row["N° de chantier"]}`,
                                        icon: {
                                            path: google.maps.SymbolPath.CIRCLE,
                                            scale: 10,
                                            fillColor: couleursEntites[row.Entité] || "gray",
                                            fillOpacity: 1,
                                            strokeWeight: 1,
                                        },
                                    });

                                    const infoWindowContent = `
                                        <div style="padding: 10px;">
                                            <h3>N° Chantier : ${row["N° de chantier"]}</h3>
                                            <p><b>Valeur :</b> ${row["CA+0"]}</p>
                                            <p><b>Entité :</b> ${row.Entité}</p>
                                            <p><b>Entretien :</b> ${row.Entretien}</p>
                                        </div>
                                    `;

                                    const infoWindow = new google.maps.InfoWindow({
                                        content: infoWindowContent,
                                    });

                                    marker.addListener("click", () => infoWindow.open(map, marker));
                                } catch (error) {
                                    console.error(`Erreur lors de la création du marqueur : ${error}, pour les coordonnées : Latitude ${row.Latitude}, Longitude ${row.Longitude}`);
                                }
                            }
                        });
                        map.fitBounds(latLngBounds);
                    },
                    error: function(error) {
                        console.error("Erreur de parsing CSV :", error);
                    }
                });
            } catch (error) {
                console.error("Erreur lors de la récupération du CSV :", error);
            }
        }
    </script>
</head>
<body onload="initMap()">
    <div id="map"></div>
</body>
</html>
